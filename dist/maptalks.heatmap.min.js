/*!
 * maptalks.heatmap v0.4.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function i(t,e){return e={exports:{}},t(e,e.exports),e.exports}function r(t,e){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var a=i[r],n=Object.getOwnPropertyDescriptor(e,a);n&&n.configurable&&void 0===t[a]&&Object.defineProperty(t,a,n)}return t}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var s=i(function(t){function e(t){return this instanceof e?(this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,void(this._data=[])):new e(t)}t.exports=e,e.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,e){e=void 0===e?15:e;var i=this._circle=this._createCanvas(),r=i.getContext("2d"),a=this._r=t+e;return i.width=i.height=2*a,r.shadowOffsetX=r.shadowOffsetY=2*a,r.shadowBlur=e,r.shadowColor="black",r.beginPath(),r.arc(-a,-a,t,0,2*Math.PI,!0),r.closePath(),r.fill(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function t(e){var i=this._createCanvas(),r=i.getContext("2d"),t=r.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var a in e)t.addColorStop(+a,e[a]);return r.fillStyle=t,r.fillRect(0,0,1,256),this._grad=r.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var e=this._ctx;e.clearRect(0,0,this._width,this._height);for(var i,r=0,a=this._data.length;r<a;r++)i=this._data[r],e.globalAlpha=Math.max(i[2]/this._max,void 0===t?.05:t),e.drawImage(this._circle,i[0]-this._r,i[1]-this._r);var n=e.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),e.putImageData(n,0,0),this},_colorize:function(t,e){for(var i,r=0,a=t.length;r<a;r+=4)i=4*t[r+3],i&&(t[r]=e[i],t[r+1]=e[i+1],t[r+2]=e[i+2])},_createCanvas:function(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}}}),h={max:1,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},radius:25,blur:15,minOpacity:.05},d=function(t){function i(e,r,o){a(this,i),Array.isArray(r)||(o=r,r=null);var s=n(this,t.call(this,e,o));return s._heats=r||[],s}return o(i,t),i.prototype.getData=function(){return this._heats},i.prototype.setData=function(t){return this._heats=t||[],this.redraw()},i.prototype.addPoint=function(t){return t?(t[0]&&Array.isArray(t[0])?e.Util.pushIn(this._heats,t):this._heats.push(t),this.redraw()):this},i.prototype.onConfig=function(e){t.prototype.onConfig.apply(this,arguments);for(var i in e)if(h[i])return this.redraw();return this},i.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearHeatCache(),t.render()),this},i.prototype.isEmpty=function(){return!this._heats.length},i.prototype.clear=function(){return this._heats=[],this.redraw(),this.fire("clear"),this},i.prototype.toJSON=function(t){t||(t={});var i={type:this.getJSONType(),id:this.getId(),options:this.config()},r=this.getData();if(t.clipExtent){var a=new e.Extent(t.clipExtent),n=this._getHeatRadius();n&&(a=a._expand(n));for(var o=[],s=0,h=r.length;s<h;s++)a.contains(new e.Coordinate(r[s][0],r[s][1]))&&o.push(r[s]);i.data=o}else i.data=r;return i},i.fromJSON=function(t){return t&&"HeatLayer"===t.type?new i(t.id,t.data,t.options):null},i.prototype._getHeatRadius=function(){return this._getRenderer()?this._getRenderer()._heatRadius:null},i}(e.Layer);d.mergeOptions(h),d.registerJSONType("HeatLayer"),d.registerRenderer("canvas",function(t){function i(){return a(this,i),n(this,t.apply(this,arguments))}return o(i,t),i.prototype.draw=function(){var t=this.getMap(),e=this.layer,i=t.getContainerExtent(),r=this.prepareCanvas(),a=i;if(r){if(r=r.convertTo(function(e){return t._pointToContainerPoint(e)}),!r.intersects(i))return void this.completeRender();a=i.intersection(r)}this._heater||(this._heater=s(this.canvas)),this._heater.radius(e.options.radius||this._heater.defaultRadius,e.options.blur),e.options.gradient&&this._heater.gradient(e.options.gradient),this._heater.max(e.options.max),this._heatViews||(this._heatViews=[]);var n=e.getData();if(0===n.length)return void this.completeRender();var o=this._heatData(n,a);this._heater.data(o).draw(e.options.minOpacity),this.completeRender()},i.prototype.drawOnInteracting=function(){this.draw()},i.prototype._heatData=function(t,i){var r=this.getMap(),a=this.layer,n=r.getProjection(),o=[],s=this._heater._r,h=void 0===a.options.max?1:a.options.max,d=e.Util.isNil(a.options.maxZoom)?r.getMaxZoom():a.options.maxZoom,c=1/Math.pow(2,Math.max(0,Math.min(d-r.getZoom(),12))),u=s/2,p=[],f=r.offsetPlatform(),l=f.x%u,_=f.y%u,y=void 0,g=void 0,v=void 0,m=void 0,w=void 0,x=void 0,b=void 0;i=i.expand(s).convertTo(function(t){return new e.Point(r._containerPointToPrj(t))}),this._heatRadius=s;for(var C=0,O=t.length;C<O;C++)y=t[C],this._heatViews[C]||(this._heatViews[C]=n.project(new e.Coordinate(y[0],y[1]))),g=this._heatViews[C],i.contains(g)&&(g=r._prjToContainerPoint(g),w=Math.floor((g.x-l)/u)+2,x=Math.floor((g.y-_)/u)+2,v=void 0!==y.alt?y.alt:void 0!==y[2]?+y[2]:1,b=v*c,p[x]=p[x]||[],m=p[x][w],m?(m[0]=(m[0]*m[2]+g.x*b)/(m[2]+b),m[1]=(m[1]*m[2]+g.y*b)/(m[2]+b),m[2]+=b):p[x][w]=[g.x,g.y,b]);for(var R=0,P=p.length;R<P;R++)if(p[R])for(var M=0,j=p[R].length;M<j;M++)m=p[R][M],m&&o.push([Math.round(m[0]),Math.round(m[1]),Math.min(m[2],h)]);return o},i.prototype.onZoomEnd=function(){delete this._heatViews,t.prototype.onZoomEnd.apply(this,arguments)},i.prototype.onResize=function(){this._heater._width=this.canvas.width,this._heater._height=this.canvas.height,t.prototype.onResize.apply(this,arguments)},i.prototype.onRemove=function(){this.clearHeatCache(),delete this._heater},i.prototype.clearHeatCache=function(){delete this._heatViews},i}(e.renderer.CanvasRenderer)),t.HeatLayer=d,Object.defineProperty(t,"__esModule",{value:!0})});